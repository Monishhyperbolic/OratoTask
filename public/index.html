<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AccessiVoice Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">
  <h1 class="text-3xl font-bold mb-4 text-gray-800">AccessiVoice Planner</h1>
  
  <!-- Status Messages -->
  <div id="statusMessage" class="hidden mb-4 p-3 rounded-lg text-white"></div>
  
  <div id="authSection" class="w-full max-w-md mb-4">
    <h2 class="text-xl font-semibold mb-2 text-gray-800">Login or Register</h2>
    <div class="flex space-x-4 mb-4">
      <input id="username" type="text" placeholder="Username" class="p-2 border rounded-lg w-1/2">
      <input id="password" type="password" placeholder="Password" class="p-2 border rounded-lg w-1/2">
    </div>
    <div class="flex space-x-4">
      <button id="loginBtn" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Login">Login</button>
      <button id="registerBtn" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Register">Register</button>
    </div>
  </div>
  
  <div id="mainSection" class="hidden w-full max-w-4xl">
    <p class="text-lg mb-4 text-gray-600">Logged in as: <span id="usernameDisplay"></span>. Say commands like "Add urgent meeting on July 20, 2025, at 3 PM", "List work tasks", or "Journal my thoughts".</p>
    <div class="flex space-x-4 mb-4">
      <button id="startVoice" class="bg-blue-500 text-white px-6 py-3 rounded-lg text-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Start voice input">Start Voice Input</button>
      <button id="journalVoice" class="bg-green-500 text-white px-6 py-3 rounded-lg text-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Start journal input">Journal Thoughts</button>
      <button id="logoutBtn" class="bg-red-500 text-white px-6 py-3 rounded-lg text-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500" aria-label="Logout">Logout</button>
    </div>
    <h2 class="text-xl font-semibold mb-2 text-gray-800">Calendar</h2>
    <div id="calendar" class="mb-4 bg-white p-4 rounded-lg shadow"></div>
    <h2 class="text-xl font-semibold mb-2 text-gray-800">Tasks</h2>
    <ul id="taskList" class="mb-4 bg-white p-4 rounded-lg shadow"></ul>
    <h2 class="text-xl font-semibold mb-2 text-gray-800">Journal Entries</h2>
    <ul id="journalList" class="bg-white p-4 rounded-lg shadow"></ul>
  </div>

  <script>
    // Check if browser supports speech recognition
    if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
      alert('Your browser does not support speech recognition. Please use Chrome or Safari.');
    }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    // DOM Elements
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const authSection = document.getElementById('authSection');
    const mainSection = document.getElementById('mainSection');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const startVoiceBtn = document.getElementById('startVoice');
    const journalVoiceBtn = document.getElementById('journalVoice');
    const taskList = document.getElementById('taskList');
    const journalList = document.getElementById('journalList');
    const calendarDiv = document.getElementById('calendar');
    const statusMessage = document.getElementById('statusMessage');

    // Show status messages
    function showStatus(message, isError = false) {
      statusMessage.textContent = message;
      statusMessage.className = `mb-4 p-3 rounded-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
      statusMessage.classList.remove('hidden');
      setTimeout(() => {
        statusMessage.classList.add('hidden');
      }, 5000);
    }

    // API Base URL - change this if your backend is running on a different port
    const API_BASE = window.location.origin;

    async function login(username, password) {
      if (!username || !password) {
        showStatus('Please enter both username and password', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
          credentials: 'include'
        });
        
        const data = await response.json();
        
        if (response.ok) {
          authSection.classList.add('hidden');
          mainSection.classList.remove('hidden');
          usernameDisplay.textContent = data.username;
          showStatus(data.message);
          loadCalendar();
          
          // Clear form
          usernameInput.value = '';
          passwordInput.value = '';
          
          // Speak success message
          const utterance = new SpeechSynthesisUtterance(data.message);
          window.speechSynthesis.speak(utterance);
        } else {
          showStatus(data.detail || 'Login failed', true);
          const utterance = new SpeechSynthesisUtterance(data.detail || 'Login failed');
          window.speechSynthesis.speak(utterance);
        }
      } catch (error) {
        console.error('Login error:', error);
        showStatus('Login failed. Please check your connection.', true);
        const utterance = new SpeechSynthesisUtterance('Login failed. Please try again.');
        window.speechSynthesis.speak(utterance);
      }
    }

    async function register(username, password) {
      if (!username || !password) {
        showStatus('Please enter both username and password', true);
        return;
      }

      if (password.length < 3) {
        showStatus('Password must be at least 3 characters long', true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          showStatus(data.message);
          // Clear form after successful registration
          usernameInput.value = '';
          passwordInput.value = '';
          
          const utterance = new SpeechSynthesisUtterance(data.message + '. You can now login.');
          window.speechSynthesis.speak(utterance);
        } else {
          showStatus(data.detail || 'Registration failed', true);
          const utterance = new SpeechSynthesisUtterance(data.detail || 'Registration failed');
          window.speechSynthesis.speak(utterance);
        }
      } catch (error) {
        console.error('Registration error:', error);
        showStatus('Registration failed. Please check your connection.', true);
        const utterance = new SpeechSynthesisUtterance('Registration failed. Please try again.');
        window.speechSynthesis.speak(utterance);
      }
    }

    function logout() {
      authSection.classList.remove('hidden');
      mainSection.classList.add('hidden');
      usernameDisplay.textContent = '';
      taskList.innerHTML = '';
      journalList.innerHTML = '';
      calendarDiv.innerHTML = '';
      showStatus('Logged out successfully');
      
      const utterance = new SpeechSynthesisUtterance('Logged out successfully');
      window.speechSynthesis.speak(utterance);
    }

    // Event listeners
    loginBtn.addEventListener('click', () => login(usernameInput.value.trim(), passwordInput.value.trim()));
    registerBtn.addEventListener('click', () => register(usernameInput.value.trim(), passwordInput.value.trim()));
    logoutBtn.addEventListener('click', logout);

    // Allow enter key to login
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login(usernameInput.value.trim(), passwordInput.value.trim());
    });
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login(usernameInput.value.trim(), passwordInput.value.trim());
    });

    async function loadCalendar() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      
      try {
        const response = await fetch(`${API_BASE}/calendar/${year}/${month}`, { 
          credentials: 'include' 
        });
        
        if (response.ok) {
          const data = await response.json();
          calendarDiv.innerHTML = data.calendar_html;
        } else {
          calendarDiv.innerHTML = '<p class="text-red-500">Failed to load calendar. Please try logging in again.</p>';
        }
      } catch (error) {
        console.error('Calendar error:', error);
        calendarDiv.innerHTML = '<p class="text-red-500">Failed to load calendar.</p>';
      }
    }

    function startRecognition(isJournal = false) {
      const btn = isJournal ? journalVoiceBtn : startVoiceBtn;
      const originalText = btn.textContent;
      
      try {
        recognition.start();
        btn.textContent = 'Listening...';
        btn.classList.add('bg-red-500', 'hover:bg-red-600');
        btn.classList.remove(isJournal ? 'bg-green-500' : 'bg-blue-500');
        
        recognition.onresult = async (event) => {
          const command = event.results[0][0].transcript;
          console.log('Voice command:', command);
          
          // Reset button
          btn.textContent = originalText;
          btn.classList.remove('bg-red-500', 'hover:bg-red-600');
          btn.classList.add(isJournal ? 'bg-green-500' : 'bg-blue-500');

          const endpoint = isJournal ? '/journal-entry' : '/process-command';
          
          try {
            const response = await fetch(`${API_BASE}${endpoint}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ command, lang: recognition.lang }),
              credentials: 'include'
            });

            if (response.ok) {
              const data = await response.json();

              // Speak the response
              const utterance = new SpeechSynthesisUtterance(data.message);
              utterance.lang = recognition.lang;
              window.speechSynthesis.speak(utterance);

              // Update UI
              if (data.tasks && data.tasks.length > 0) {
                taskList.innerHTML = '';
                data.tasks.forEach(task => {
                  const li = document.createElement('li');
                  li.textContent = `${task.name} - ${task.date} ${task.time || ''} (${task.priority} priority, ${task.category || 'uncategorized'})`;
                  li.className = `p-2 border-b ${task.priority === 'high' ? 'text-red-600' : task.priority === 'medium' ? 'text-yellow-600' : 'text-green-600'}`;
                  li.setAttribute('role', 'listitem');
                  taskList.appendChild(li);
                });
                loadCalendar(); // Refresh calendar when tasks change
              }
              
              if (data.journalEntries && data.journalEntries.length > 0) {
                journalList.innerHTML = '';
                data.journalEntries.forEach(entry => {
                  const li = document.createElement('li');
                  li.textContent = `${entry.date}: ${entry.content}`;
                  li.className = 'p-2 border-b text-gray-800';
                  li.setAttribute('role', 'listitem');
                  journalList.appendChild(li);
                });
              }
              
              showStatus('Command processed successfully');
            } else {
              const errorData = await response.json();
              throw new Error(errorData.detail || 'Command processing failed');
            }
          } catch (error) {
            console.error('Command processing error:', error);
            const errorMessage = error.message.includes('authenticated') ? 
              'Please login first' : 'Error processing command. Please try again.';
            
            const utterance = new SpeechSynthesisUtterance(errorMessage);
            utterance.lang = recognition.lang;
            window.speechSynthesis.speak(utterance);
            
            showStatus(errorMessage, true);
          }
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          
          // Reset button
          btn.textContent = originalText;
          btn.classList.remove('bg-red-500', 'hover:bg-red-600');
          btn.classList.add(isJournal ? 'bg-green-500' : 'bg-blue-500');
          
          let errorMessage = 'Sorry, I could not understand. Please try again.';
          if (event.error === 'not-allowed') {
            errorMessage = 'Microphone access denied. Please allow microphone access and try again.';
          } else if (event.error === 'no-speech') {
            errorMessage = 'No speech detected. Please try again.';
          }
          
          const utterance = new SpeechSynthesisUtterance(errorMessage);
          utterance.lang = recognition.lang;
          window.speechSynthesis.speak(utterance);
          
          showStatus(errorMessage, true);
        };
        
      } catch (error) {
        console.error('Recognition start error:', error);
        btn.textContent = originalText;
        btn.classList.remove('bg-red-500', 'hover:bg-red-600');
        btn.classList.add(isJournal ? 'bg-green-500' : 'bg-blue-500');
        
        showStatus('Speech recognition not available', true);
      }
    }

    startVoiceBtn.addEventListener('click', () => startRecognition(false));
    journalVoiceBtn.addEventListener('click', () => startRecognition(true));

    // Language setting function (if needed)
    async function setLanguage(lang) {
      recognition.lang = lang;
      const utterance = new SpeechSynthesisUtterance(`Language set to ${lang}.`);
      utterance.lang = lang;
      window.speechSynthesis.speak(utterance);
      showStatus(`Language set to ${lang}`);
    }

    // Initialize the app
    console.log('AccessiVoice Planner loaded successfully');
  </script>
</body>
</html>